<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaagai Progress Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* A very light, neutral green-grey */
        }
        /* Simple spinner */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* Custom scrollbar for activity logs */
        .activity-log::-webkit-scrollbar {
            width: 6px;
        }
        .activity-log::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .activity-log::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        .activity-log::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main Application Container -->
    <div id="app-content">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <h1 class="text-3xl font-bold text-center text-teal-700">Vaagai Progress Tracker</h1>
                <p class="text-center text-gray-600">Student Progress & Parent Collaboration</p>
            </div>
        </header>

        <!-- Loading Spinner (Initially visible, hidden by JS) -->
        <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
            <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
        </div>

        <!-- Main Content Area -->
        <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">

            <!-- 1. Role Selector (Default View - hidden until loader is done) -->
            <div id="role-selector-view" class="hidden">
                <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto">
                    <h2 class="text-2xl font-semibold text-center text-gray-800 mb-6">Select Your Role</h2>
                    <div class="space-y-4">
                        <button id="teacher-role-btn" class="w-full bg-teal-600 text-white py-3 px-6 rounded-lg font-medium text-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition duration-200">
                            Teacher / TA Login
                        </button>
                        <button id="parent-role-btn" class="w-full bg-gray-700 text-white py-3 px-6 rounded-lg font-medium text-lg shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200">
                            Parent View
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. Teacher / TA View (Hidden by default) -->
            <div id="teacher-view" class="hidden">
                <!-- Back Button -->
                <button id="teacher-back-btn" class="mb-4 text-teal-600 hover:text-teal-800 font-medium">&larr; Back to Role Selection</button>
                
                <!-- 2a. Teacher/TA Secure Login (Initially visible) -->
                <div id="teacher-login-view">
                    <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto">
                        <h2 class="text-2xl font-semibold text-center text-gray-800 mb-6">Teacher / TA Secure Login</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="teacher-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" id="teacher-username" placeholder="e.g., Karthik" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="teacher-code" class="block text-sm font-medium text-gray-700 mb-1">Access Code</label>
                                <input type="password" id="teacher-code" placeholder="Enter your secret code" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <button id="teacher-login-btn" class="w-full bg-teal-600 text-white py-3 px-6 rounded-lg font-medium text-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition duration-200">
                                Log In
                            </button>
                            <p id="teacher-login-error" class="text-red-500 text-sm text-center hidden"></p>
                        </div>
                    </div>
                </div>

                <!-- 2b. Teacher Dashboard (Hidden until logged in) -->
                <div id="teacher-dashboard" class="hidden">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2 sm:mb-0">Teacher Dashboard</h2>
                        <span id="welcome-user" class="text-lg text-gray-600"></span>
                    </div>

                    <!-- Class Loader -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Load Your Class</h3>
                        <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
                            <input type="text" id="class-name-input" placeholder="Enter Class Name (e.g., Tamil Class 2025)" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                            <button id="load-class-btn" class="bg-teal-600 text-white py-2 px-6 rounded-lg font-medium shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition duration-200">
                                Create / Load Class
                            </button>
                        </div>
                        <p id="class-load-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    </div>

                    <!-- Dashboard Content (Hidden until class is loaded) -->
                    <div id="class-content" class="hidden">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">
                            Class: <span id="display-class-name" class="text-teal-700"></span>
                            (<span id="display-class-id" class="text-gray-500 text-sm font-mono"></span>)
                        </h3>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                            <!-- Column 1: Students -->
                            <div class="space-y-6">
                                <!-- Student Roster -->
                                <div class="bg-white p-6 rounded-2xl shadow-lg">
                                    <h4 class="text-xl font-semibold text-gray-800 mb-4">Student Roster</h4>
                                    <!-- Add Student (Teacher Only) -->
                                    <div id="add-student-section" class="mb-4 space-y-2 sm:space-y-0 sm:flex sm:space-x-2">
                                        <input type="text" id="new-student-name" placeholder="New Student Name" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                                        <button id="add-student-btn" class="w-full sm:w-auto bg-blue-600 text-white py-2 px-5 rounded-lg font-medium shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                                            Add Student
                                        </button>
                                    </div>
                                    <p id="add-student-error" class="text-red-500 text-sm mb-2 hidden"></p>
                                    <!-- Student List -->
                                    <p class="text-sm text-gray-500 mb-2">Click a student to view their log.</p>
                                    <div id="student-list" class="space-y-3">
                                        <p class="text-gray-500">No students added yet.</p>
                                    </div>
                                </div>

                                <!-- Class Goals -->
                                <div class="bg-white p-6 rounded-2xl shadow-lg">
                                    <h4 class="text-xl font-semibold text-gray-800 mb-4">Class Goals ("Can Do" Statements)</h4>
                                    <!-- Add Goal (Teacher Only) -->
                                    <div id="add-goal-section" class="mb-4 space-y-2 sm:space-y-0 sm:flex sm:space-x-2">
                                        <input type="text" id="new-goal-statement" placeholder="Enter new 'Can Do' statement" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                                        <button id="add-goal-btn" class="w-full sm:w-auto bg-blue-600 text-white py-2 px-5 rounded-lg font-medium shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                                            Add Goal
                                        </button>
                                    </div>
                                    <p id="add-goal-error" class="text-red-500 text-sm mb-2 hidden"></p>
                                    <!-- Goal List -->
                                    <ul id="goal-list" class="space-y-2 list-disc list-inside text-gray-700 max-h-60 overflow-y-auto activity-log pr-2">
                                        <!-- Goals will be dynamically added here -->
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Column 2: Progress Logging -->
                            <div class="space-y-6">
                                <!-- Log Student Progress -->
                                <div class="bg-white p-6 rounded-2xl shadow-lg">
                                    <h4 class="text-xl font-semibold text-gray-800 mb-4">Log Student Progress</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="progress-student-select" class="block text-sm font-medium text-gray-700 mb-1">Student</label>
                                            <select id="progress-student-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-white">
                                                <option value="">Select a student...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="progress-goal-select" class="block text-sm font-medium text-gray-700 mb-1">"Can Do" Statement (Goal)</label>
                                            <select id="progress-goal-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-white">
                                                <option value="">Select a goal...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="progress-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                            <input type="date" id="progress-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                                        </div>
                                        <div>
                                            <label for="progress-classifier" class="block text-sm font-medium text-gray-700 mb-1">Classifier</label>
                                            <select id="progress-classifier" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-white">
                                                <option value="Getting acquainted">1. Getting acquainted</option>
                                                <option value="Actively trying">2. Actively trying</option>
                                                <option value="Mastered">3. Mastered</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="progress-statement" class="block text-sm font-medium text-gray-700 mb-1">Observation / Statement</label>
                                            <textarea id="progress-statement" rows="3" placeholder="e.g., 'Successfully formed 3-word sentences.'" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500"></textarea>
                                        </div>
                                        <button id="log-progress-btn" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-medium text-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200">
                                            Log Progress
                                        </button>
                                        <p id="log-progress-error" class="text-red-500 text-sm text-center hidden"></p>
                                        <p id="log-progress-success" class="text-green-600 text-sm text-center hidden">Progress logged successfully!</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Column 3: Activity Log -->
                            <div class="space-y-6">
                                <!-- Student Activity Log -->
                                <div class="bg-white p-6 rounded-2xl shadow-lg">
                                    <h4 class="text-xl font-semibold text-gray-800 mb-4">Student Activity Log</h4>
                                    <p class="text-sm text-gray-600 mb-2">Viewing: <span id="teacher-log-student-name" class="font-medium text-teal-700">None selected</span></p>
                                    <div id="teacher-activity-log" class="space-y-4 max-h-[40rem] overflow-y-auto activity-log pr-2">
                                        <!-- Activity will be dynamically added here -->
                                        <p class="text-gray-500">Select a student from the roster to see their activity.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- 3. Parent View (Hidden by default) -->
            <div id="parent-view" class="hidden">
                <!-- Back Button -->
                <button id="parent-back-btn" class="mb-4 text-teal-600 hover:text-teal-800 font-medium">&larr; Back to Role Selection</button>

                <!-- 3a. Parent Login (Initially visible) -->
                <div id="parent-login-view">
                    <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto">
                        <h2 class="text-2xl font-semibold text-center text-gray-800 mb-6">Parent Portal Login</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="parent-access-code" class="block text-sm font-medium text-gray-700 mb-1">Student Access Code</label>
                                <input type="text" id="parent-access-code" placeholder="Enter your child's unique code" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <button id="parent-login-btn" class="w-full bg-gray-700 text-white py-3 px-6 rounded-lg font-medium text-lg shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200">
                                View Progress
                            </button>
                            <p id="parent-login-error" class="text-red-500 text-sm text-center hidden"></p>
                        </div>
                    </div>
                </div>
                
                <!-- 3b. Parent Dashboard (Hidden until logged in) -->
                <div id="parent-dashboard" class="hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Progress Report for <span id="parent-student-name" class="text-teal-700"></span></h2>
                    <p class="text-gray-600 mb-6">Class: <span id="parent-class-name" class="font-medium"></span></p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        <!-- Add Parent Observation -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h4 class="text-xl font-semibold text-gray-800 mb-4">Add Parent Observation</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="parent-goal-select" class="block text-sm font-medium text-gray-700 mb-1">"Can Do" Statement (Goal)</label>
                                    <select id="parent-goal-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-white">
                                        <option value="">Select a goal...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="parent-obs-date" class="block text-sm font-medium text-gray-700 mb-1">Date of Observation</label>
                                    <input type="date" id="parent-obs-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                                </div>
                                <div>
                                    <label for="parent-observation" class="block text-sm font-medium text-gray-700 mb-1">Observation / Comment</label>
                                    <textarea id="parent-observation" rows="3" placeholder="e.g., 'We practiced this at home today!'" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500"></textarea>
                                </div>
                                <button id="log-parent-obs-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium text-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                                    Add Observation
                                </button>
                                <p id="parent-log-error" class="text-red-500 text-sm text-center hidden"></p>
                                <p id="parent-log-success" class="text-green-600 text-sm text-center hidden">Observation added!</p>
                            </div>
                        </div>

                        <!-- Recent Activity Log -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h4 class="text-xl font-semibold text-gray-800 mb-4">Recent Activity Log</h4>
                            <div id="parent-activity-log" class="space-y-4 max-h-96 overflow-y-auto activity-log pr-2">
                                <!-- Activity will be dynamically added here -->
                                <p class="text-gray-500">No activity logged yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken,
            onAuthStateChanged,
            setPersistence,
            inMemoryPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            arrayUnion,
            onSnapshot,
            collection,
            query,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration & Global State ---
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-vaagai';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        let userId = null;
        let isAuthReady = false;

        let classData = {};
        let parentStudentData = {};
        
        let unsubClass = null;
        let unsubTeacherStudentLogs = null;
        let unsubParentStudentLogs = null;

        let currentTeacherLogStudentId = null; // Track which student log the teacher is viewing

        const teacherCredentials = {
            "Karthik": { code: "Vaazhga1", role: "teacher" },
            "Paneer": { code: "Vaazhga2", role: "ta" },
            "Lakshanya": { code: "Vaazhga3", role: "ta" },
            "Anshruta": { code: "Vaazhga4", role: "ta" }
        };
        let currentUserRole = null;
        let currentUsername = null;

        // --- Default Data ---
        const defaultGoals = [
            "Read and write 3 letter words. That has  உ, ஓ, ஊ வரிசை sounds",
            "I can understand directions in Tamil",
            "I can form 3 word sentences ending in verb. ( In English/ junoon tamil it ends in object)",
            "I can represent plural words",
            "I can recognize gender in context and use the right gender while speaking and writing",
            "I can use the right tense"
        ];

        // --- DOM Element References ---
        // We establish this object early, but will access it inside functions
        // to ensure elements are ready.
        const elements = {
            loadingSpinner: document.getElementById('loading-spinner'),
            appContent: document.getElementById('app-content'),
            
            roleSelectorView: document.getElementById('role-selector-view'),
            teacherRoleBtn: document.getElementById('teacher-role-btn'),
            parentRoleBtn: document.getElementById('parent-role-btn'),
            
            teacherView: document.getElementById('teacher-view'),
            teacherBackBtn: document.getElementById('teacher-back-btn'),
            teacherLoginView: document.getElementById('teacher-login-view'),
            teacherUsername: document.getElementById('teacher-username'),
            teacherCode: document.getElementById('teacher-code'),
            teacherLoginBtn: document.getElementById('teacher-login-btn'),
            teacherLoginError: document.getElementById('teacher-login-error'),
            
            teacherDashboard: document.getElementById('teacher-dashboard'),
            welcomeUser: document.getElementById('welcome-user'),
            classNameInput: document.getElementById('class-name-input'),
            loadClassBtn: document.getElementById('load-class-btn'),
            classLoadError: document.getElementById('class-load-error'),
            classContent: document.getElementById('class-content'),
            displayClassName: document.getElementById('display-class-name'),
            displayClassId: document.getElementById('display-class-id'),
            
            addStudentSection: document.getElementById('add-student-section'),
            newStudentName: document.getElementById('new-student-name'),
            addStudentBtn: document.getElementById('add-student-btn'),
            addStudentError: document.getElementById('add-student-error'),
            studentList: document.getElementById('student-list'),
            
            addGoalSection: document.getElementById('add-goal-section'),
            newGoalStatement: document.getElementById('new-goal-statement'),
            addGoalBtn: document.getElementById('add-goal-btn'),
            addGoalError: document.getElementById('add-goal-error'),
            goalList: document.getElementById('goal-list'),

            progressStudentSelect: document.getElementById('progress-student-select'),
            progressGoalSelect: document.getElementById('progress-goal-select'),
            progressDate: document.getElementById('progress-date'),
            progressClassifier: document.getElementById('progress-classifier'),
            progressStatement: document.getElementById('progress-statement'),
            logProgressBtn: document.getElementById('log-progress-btn'),
            logProgressError: document.getElementById('log-progress-error'),
            logProgressSuccess: document.getElementById('log-progress-success'),
            
            teacherLogStudentName: document.getElementById('teacher-log-student-name'),
            teacherActivityLog: document.getElementById('teacher-activity-log'),
            
            parentView: document.getElementById('parent-view'),
            parentBackBtn: document.getElementById('parent-back-btn'),
            parentLoginView: document.getElementById('parent-login-view'),
            parentAccessCode: document.getElementById('parent-access-code'),
            parentLoginBtn: document.getElementById('parent-login-btn'),
            parentLoginError: document.getElementById('parent-login-error'),

            parentDashboard: document.getElementById('parent-dashboard'),
            parentStudentName: document.getElementById('parent-student-name'),
            parentClassName: document.getElementById('parent-class-name'),
            parentGoalSelect: document.getElementById('parent-goal-select'),
            parentObsDate: document.getElementById('parent-obs-date'),
            parentObservation: document.getElementById('parent-observation'),
            logParentObsBtn: document.getElementById('log-parent-obs-btn'),
            parentLogSuccess: document.getElementById('parent-log-success'),
            parentLogError: document.getElementById('parent-log-error'),
            parentActivityLog: document.getElementById('parent-activity-log')
        };
        
        // --- Utility Functions ---

        function generateAccessCode() {
            const words = ["APPLE", "BLUE", "CAT", "DOG", "SUN", "MOON", "STAR", "TREE", "FISH", "BIRD"];
            const word = words[Math.floor(Math.random() * words.length)];
            const num = Math.floor(1000 + Math.random() * 9000);
            return `${word}-${num}`;
        }
        
        function formatDate(date) {
            if (!date) return 'No date';
            // Handle both Firebase Timestamps and JS Date objects/strings
            const dateObj = date.toDate ? date.toDate() : (typeof date === 'string' || date instanceof Date ? new Date(date) : new Date());
            return dateObj.toISOString().split('T')[0];
        }

        function show(element) {
            if (element) element.classList.remove('hidden');
        }
        
        function hide(element) {
            if (element) element.classList.add('hidden');
        }

        function resetViews() {
            hide(elements.roleSelectorView);
            hide(elements.teacherView);
            hide(elements.parentView);
            hide(elements.teacherLoginView);
            hide(elements.teacherDashboard);
            hide(elements.parentLoginView);
            hide(elements.parentDashboard);
            hide(elements.classContent);

            if (unsubClass) unsubClass();
            if (unsubTeacherStudentLogs) unsubTeacherStudentLogs();
            if (unsubParentStudentLogs) unsubParentStudentLogs();
            unsubClass = null;
            unsubTeacherStudentLogs = null;
            unsubParentStudentLogs = null;
            currentTeacherLogStudentId = null;
        }

        // --- Database Path Generators ---
        
        function getTeacherClassDocRef(classId) {
            return doc(db, 'artifacts', appId, 'public', 'data', 'vaagai_classes_v2', classId);
        }

        function getPublicAccessDocRef(accessCode) {
            return doc(db, 'artifacts', appId, 'public', 'data', 'access_codes_v2', accessCode);
        }

        function getStudentLogsCollectionRef(classId, studentId) {
            return collection(db, 'artifacts', appId, 'public', 'data', 'vaagai_classes_v2', classId, 'student_logs', studentId, 'logs');
        }

        // --- Core Application Logic ---

        async function initializeAppAndAuth() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase config is missing or empty.");
                }
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('error');

                await setPersistence(auth, inMemoryPersistence);

                console.log("Firebase services initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Auth state changed. User ID:", userId);
                    } else {
                        isAuthReady = false;
                        userId = null;
                        console.log("Auth state: No user. Attempting sign-in...");
                        
                        try {
                            if (initialAuthToken) {
                                console.log("Signing in with custom token...");
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                console.log("Signing in anonymously...");
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Error during sign-in:", authError);
                            showAuthError("Could not authenticate with services. Please refresh.");
                        }
                    }
                });

            } catch (error) {
                console.error("Fatal Error initializing Firebase:", error);
                showAuthError(`Failed to initialize application: ${error.message}`);
            } finally {
                // *** FIX: This GUARANTEES the UI becomes visible ***
                // This block runs whether the try succeeds or fails.
                hide(elements.loadingSpinner);
                show(elements.roleSelectorView); // Show the default view
                console.log("Initialization complete. UI unlocked.");
            }
        }
        
        function showAuthError(message) {
            console.error("AUTH/INIT ERROR:", message);
            
            // Show error in all possible login/load areas
            const errorElements = [
                elements.teacherLoginError, 
                elements.parentLoginError, 
                elements.classLoadError
            ];
            errorElements.forEach(el => {
                if (el) {
                    el.innerText = message;
                    show(el);
                }
            });
        }

        // --- View Navigation ---
        
        function showRoleSelector() {
            resetViews();
            show(elements.roleSelectorView);
        }

        function showTeacherLogin() {
            resetViews();
            show(elements.teacherView);
            show(elements.teacherLoginView);
        }

        function showParentLogin() {
            resetViews();
            show(elements.parentView);
            show(elements.parentLoginView);
        }
        
        function showTeacherDashboard() {
            resetViews();
            show(elements.teacherView);
            show(elements.teacherDashboard);
            
            elements.welcomeUser.innerText = `Welcome, ${currentUsername}!`;
            if (currentUserRole === 'ta') {
                hide(elements.addStudentSection);
                hide(elements.addGoalSection);
            } else {
                show(elements.addStudentSection);
                show(elements.addGoalSection);
            }
        }
        
        function showParentDashboard() {
            resetViews();
            show(elements.parentView);
            show(elements.parentDashboard);
        }

        // --- Teacher: Authentication & Class Management ---

        function handleTeacherLogin() {
            const username = elements.teacherUsername.value.trim();
            const code = elements.teacherCode.value.trim();
            hide(elements.teacherLoginError);
            
            const user = teacherCredentials[username];
            
            if (user && user.code === code) {
                currentUserRole = user.role;
                currentUsername = username;
                elements.teacherUsername.value = '';
                elements.teacherCode.value = '';
                showTeacherDashboard();
            } else {
                elements.teacherLoginError.innerText = "Invalid username or access code.";
                show(elements.teacherLoginError);
            }
        }
        
        async function createOrLoadClass() {
            const className = elements.classNameInput.value.trim();
            if (!className) {
                elements.classLoadError.innerText = "Please enter a class name.";
                show(elements.classLoadError);
                return;
            }

            if (!isAuthReady || !userId) {
                elements.classLoadError.innerText = "Authentication not ready. Please wait and try again.";
                show(elements.classLoadError);
                return;
            }
            
            hide(elements.classLoadError);
            
            // Simple hash for classId based on name
            let hash = 0;
            for (let i = 0; i < className.length; i++) {
                const char = className.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            const classId = `class_${Math.abs(hash)}`;

            const classDocRef = getTeacherClassDocRef(classId);

            try {
                const docSnap = await getDoc(classDocRef);
                
                if (!docSnap.exists()) {
                    console.log("Class not found. Creating new class...");
                    const newClassData = {
                        className: className,
                        classId: classId,
                        teacherId: userId, // Use the authenticated user's ID
                        createdAt: Timestamp.now(),
                        students: [],
                        goals: defaultGoals
                    };
                    await setDoc(classDocRef, newClassData);
                }

                // Attach listener regardless of creation or loading
                attachClassListener(classId);
                
                elements.displayClassName.innerText = className;
                elements.displayClassId.innerText = `ID: ${classId}`;
                show(elements.classContent);

            } catch (error) {
                console.error("Error creating or loading class:", error);
                elements.classLoadError.innerText = `Error: ${error.message}. Check console.`;
                show(elements.classLoadError);
            }
        }
        
        function attachClassListener(classId) {
            if (unsubClass) unsubClass();
            
            const classDocRef = getTeacherClassDocRef(classId);
            
            unsubClass = onSnapshot(classDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    classData = docSnap.data();
                    console.log("Class data updated:", classData);
                    renderStudentList();
                    renderGoalList();
                    updateSelectDropdowns();
                } else {
                    console.warn("Class document no longer exists.");
                    hide(elements.classContent);
                    elements.classLoadError.innerText = "The loaded class data could not be found.";
                    show(elements.classLoadError);
                }
            }, (error) => {
                console.error("Error in class listener:", error);
                elements.classLoadError.innerText = "Error listening to class data.";
                show(elements.classLoadError);
            });
        }

        // --- Teacher: Student & Goal Management ---
        
        async function addStudent() {
            if (!elements.newStudentName) {
                console.error("Add student input not found");
                return;
            }
            const studentName = elements.newStudentName.value.trim();
            if (!studentName) {
                elements.addStudentError.innerText = "Please enter a student name.";
                show(elements.addStudentError);
                return;
            }
            
            hide(elements.addStudentError);

            const newStudentId = `student_${Date.now()}`;
            let newAccessCode = generateAccessCode();
            
            const newStudent = {
                id: newStudentId,
                name: studentName,
                accessCode: newAccessCode
            };

            // Create the public access code document
            const accessDocRef = getPublicAccessDocRef(newAccessCode);
            const accessData = {
                classId: classData.classId,
                studentId: newStudentId,
                className: classData.className,
                studentName: newStudent.name
            };

            try {
                // Check if access code already exists (rare, but good practice)
                const accessDocSnap = await getDoc(accessDocRef);
                if (accessDocSnap.exists()) {
                    throw new Error("Access code collision. Please try again.");
                }
                
                // 1. Create the public access doc
                await setDoc(accessDocRef, accessData);

                // 2. Add student to the class document
                const classDocRef = getTeacherClassDocRef(classData.classId);
                await updateDoc(classDocRef, {
                    students: arrayUnion(newStudent)
                });

                console.log("Student added successfully:", newStudent.name);
                elements.newStudentName.value = '';

            } catch (error)
            {
                console.error("Error adding student:", error);
                elements.addStudentError.innerText = `Error: ${error.message}`;
                show(elements.addStudentError);
            }
        }

        async function addGoal() {
            const newGoal = elements.newGoalStatement.value.trim();
            if (!newGoal) {
                elements.addGoalError.innerText = "Please enter a goal statement.";
                show(elements.addGoalError);
                return;
            }
            hide(elements.addGoalError);

            try {
                const classDocRef = getTeacherClassDocRef(classData.classId);
                await updateDoc(classDocRef, {
                    goals: arrayUnion(newGoal)
                });
                
                console.log("Goal added successfully.");
                elements.newGoalStatement.value = '';

            } catch (error) {
                console.error("Error adding goal:", error);
                elements.addGoalError.innerText = `Error: ${error.message}`;
                show(elements.addGoalError);
            }
        }
        
        async function logProgress() {
            const studentId = elements.progressStudentSelect.value;
            const goal = elements.progressGoalSelect.value;
            const date = elements.progressDate.value;
            const classifier = elements.progressClassifier.value;
            const statement = elements.progressStatement.value.trim();
            
            hide(elements.logProgressError);
            hide(elements.logProgressSuccess);
            
            if (!studentId || !goal || !date || !statement) {
                elements.logProgressError.innerText = "Please fill out all fields.";
                show(elements.logProgressError);
                return;
            }

            const logEntry = {
                id: `log_${Date.now()}`,
                studentId: studentId,
                goal: goal,
                date: Timestamp.fromDate(new Date(date)),
                classifier: classifier,
                statement: statement,
                reporter: "teacher", // 'teacher' (TA) or 'parent'
                reporterName: currentUsername, // Track who made the entry
                createdAt: Timestamp.now()
            };

            try {
                // Log goes into a subcollection for that student
                const logsCollectionRef = getStudentLogsCollectionRef(classData.classId, studentId);
                await setDoc(doc(logsCollectionRef, logEntry.id), logEntry);
                
                console.log("Progress logged successfully.");
                
                elements.logProgressSuccess.innerText = "Progress logged successfully!";
                show(elements.logProgressSuccess);
                elements.progressStatement.value = '';
                elements.progressStudentSelect.value = '';
                
                setTimeout(() => hide(elements.logProgressSuccess), 3000);

            } catch (error) {
                console.error("Error logging progress:", error);
                elements.logProgressError.innerText = `Error: ${error.message}`;
                show(elements.logProgressError);
            }
        }
        
        /**
         * Attaches a real-time listener to a single student's log for the TEACHER view.
         */
        function attachTeacherLogListener(studentId, studentName) {
            if (unsubTeacherStudentLogs) unsubTeacherStudentLogs();
            
            currentTeacherLogStudentId = studentId;
            elements.teacherLogStudentName.innerText = studentName;
            elements.teacherActivityLog.innerHTML = `<p class="text-gray-500">Loading log for ${studentName}...</p>`;
            
            const logsCollectionRef = getStudentLogsCollectionRef(classData.classId, studentId);
            const q = query(logsCollectionRef);
            
            unsubTeacherStudentLogs = onSnapshot(q, (querySnapshot) => {
                let logs = [];
                querySnapshot.forEach((doc) => {
                    logs.push(doc.data());
                });
                // Sort logs by date, newest first
                logs.sort((a, b) => b.date.toMillis() - a.date.toMillis());
                renderTeacherActivityLog(logs);
            }, (error) => {
                console.error("Error in teacher student log listener:", error);
                elements.teacherActivityLog.innerHTML = `<p class="text-red-500">Error loading log.</p>`;
            });
        }


        // --- Teacher: UI Rendering ---

        function renderStudentList() {
            elements.studentList.innerHTML = '';
            
            if (!classData.students || classData.students.length === 0) {
                elements.studentList.innerHTML = '<p class="text-gray-500">No students added yet.</p>';
                return;
            }
            
            classData.students.forEach(student => {
                const studentEl = document.createElement('div');
                const isActive = student.id === currentTeacherLogStudentId;
                studentEl.className = `p-3 ${isActive ? 'bg-teal-100 border-teal-400' : 'bg-gray-100 border-gray-100'} border rounded-lg flex justify-between items-center cursor-pointer hover:bg-gray-200`;
                studentEl.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-800">${student.name}</span>
                        <code class="block text-sm text-blue-600 bg-blue-100 px-2 py-0.5 rounded">${student.accessCode}</code>
                    </div>
                `;
                studentEl.addEventListener('click', () => {
                    attachTeacherLogListener(student.id, student.name);
                    renderStudentList(); // Re-render to show active state
                });
                elements.studentList.appendChild(studentEl);
            });
        }
        
        function renderGoalList() {
            elements.goalList.innerHTML = '';
            
            if (!classData.goals || classData.goals.length === 0) {
                elements.goalList.innerHTML = '<li class="text-gray-500">No goals added yet.</li>';
                return;
            }
            
            classData.goals.forEach(goal => {
                const goalEl = document.createElement('li');
                goalEl.textContent = goal;
                elements.goalList.appendChild(goalEl);
            });
        }
        
        function updateSelectDropdowns() {
            const students = classData.students || [];
            const goals = classData.goals || [];
            
            // Populate teacher progress form
            elements.progressStudentSelect.innerHTML = '<option value="">Select a student...</option>';
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                elements.progressStudentSelect.appendChild(option);
            });
            
            elements.progressGoalSelect.innerHTML = '<option value="">Select a goal...</option>';
            goals.forEach(goal => {
                const option = document.createElement('option');
                option.value = goal;
                option.textContent = goal;
                elements.progressGoalSelect.appendChild(option);
            });
            
            // Populate parent observation form
            elements.parentGoalSelect.innerHTML = '<option value="">Select a goal...</option>';
            goals.forEach(goal => {
                const option = document.createElement('option');
                option.value = goal;
                option.textContent = goal;
                elements.parentGoalSelect.appendChild(option);
            });
        }
        
        /**
         * Renders the student's activity log for the TEACHER.
         * Shows full TA names.
         */
        function renderTeacherActivityLog(logs) {
            elements.teacherActivityLog.innerHTML = '';
            if (!logs || logs.length === 0) {
                elements.teacherActivityLog.innerHTML = '<p class="text-gray-500">No activity logged for this student yet.</p>';
                return;
            }
            
            logs.forEach(log => {
                const isParentLog = log.reporter === 'parent';
                const bgColor = isParentLog ? 'bg-blue-50' : 'bg-green-50';
                const titleColor = isParentLog ? 'text-blue-700' : 'text-green-700';
                const reporterName = log.reporterName || (isParentLog ? 'Parent' : 'Teacher');

                const logEl = document.createElement('div');
                logEl.className = `p-4 rounded-lg border ${bgColor} ${isParentLog ? 'border-blue-200' : 'border-green-200'} shadow-sm`;
                logEl.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold ${titleColor}">${log.goal}</span>
                        <span class="text-sm font-medium text-gray-600">${formatDate(log.date)}</span>
                    </div>
                    <p class="text-gray-700 mb-2">"${log.statement}"</p>
                    <div class="flex justify-between items-baseline">
                        <span class="text-sm font-medium ${titleColor}">${log.classifier}</span>
                        <span class="text-xs text-gray-500">by ${reporterName}</span>
                    </div>
                `;
                elements.teacherActivityLog.appendChild(logEl);
            });
        }


        // --- Parent: Authentication & Data Loading ---

        async function handleParentLogin() {
            const accessCode = elements.parentAccessCode.value.trim().toUpperCase();
            if (!accessCode) {
                elements.parentLoginError.innerText = "Please enter an access code.";
                show(elements.parentLoginError);
                return;
            }

            if (!isAuthReady || !userId) {
                elements.parentLoginError.innerText = "Authentication not ready. Please wait and try again.";
                show(elements.parentLoginError);
                return;
            }

            hide(elements.parentLoginError);

            try {
                // 1. Look up the access code in the public collection
                const accessDocRef = getPublicAccessDocRef(accessCode);
                const accessDocSnap = await getDoc(accessDocRef);
                
                if (!accessDocSnap.exists()) {
                    throw new Error("Invalid access code. Please check and try again.");
                }
                
                parentStudentData = accessDocSnap.data();
                console.log("Parent access successful:", parentStudentData);
                
                // 2. Get the main class data (for goals)
                const classDocRef = getTeacherClassDocRef(parentStudentData.classId);
                const classDocSnap = await getDoc(classDocRef);
                
                if (!classDocSnap.exists()) {
                    throw new Error("Could not find the associated class data.");
                }
                
                classData = classDocSnap.data();
                
                // 3. Attach listener to the student's private log subcollection
                attachParentLogListener(parentStudentData.classId, parentStudentData.studentId);
                
                // 4. Render dashboard
                elements.parentStudentName.innerText = parentStudentData.studentName;
                elements.parentClassName.innerText = parentStudentData.className;
                updateSelectDropdowns(); // Populate parent goal dropdown
                showParentDashboard();

            } catch (error) {
                console.error("Error during parent login:", error);
                elements.parentLoginError.innerText = `Error: ${error.message}`;
                show(elements.parentLoginError);
            }
        }
        
        function attachParentLogListener(classId, studentId) {
            if (unsubParentStudentLogs) unsubParentStudentLogs();
            
            const logsCollectionRef = getStudentLogsCollectionRef(classId, studentId);
            const q = query(logsCollectionRef);
            
            unsubParentStudentLogs = onSnapshot(q, (querySnapshot) => {
                let logs = [];
                querySnapshot.forEach((doc) => {
                    logs.push(doc.data());
                });
                // Sort logs by date, newest first
                logs.sort((a, b) => b.date.toMillis() - a.date.toMillis());
                renderParentActivityLog(logs);
            }, (error) => {
                console.error("Error in parent student log listener:", error);
                elements.parentActivityLog.innerHTML = `<p class="text-red-500">Error loading log.</p>`;
            });
        }
        
        async function logParentObservation() {
            const goal = elements.parentGoalSelect.value;
            const date = elements.parentObsDate.value;
            const statement = elements.parentObservation.value.trim();
            
            hide(elements.parentLogError);
            hide(elements.parentLogSuccess);
            
            if (!goal || !date || !statement) {
                elements.parentLogError.innerText = "Please fill out all fields.";
                show(elements.parentLogError);
                return;
            }

            const logEntry = {
                id: `log_parent_${Date.now()}`,
                studentId: parentStudentData.studentId,
                goal: goal,
                date: Timestamp.fromDate(new Date(date)),
                classifier: "Parent Observation",
                statement: statement,
                reporter: "parent",
                reporterName: "Parent",
                createdAt: Timestamp.now()
            };
            
            try {
                const logsCollectionRef = getStudentLogsCollectionRef(parentStudentData.classId, parentStudentData.studentId);
                await setDoc(doc(logsCollectionRef, logEntry.id), logEntry);
                
                console.log("Parent observation logged successfully.");
                
                elements.parentLogSuccess.innerText = "Observation added successfully!";
                show(elements.parentLogSuccess);
                elements.parentObservation.value = '';
                
                setTimeout(() => hide(elements.parentLogSuccess), 3000);

            } catch (error) {
                console.error("Error logging parent observation:", error);
                elements.parentLogError.innerText = `Error: ${error.message}`;
                show(elements.parentLogError);
            }
        }


        // --- Parent: UI Rendering ---
        
        /**
         * Renders the student's activity log for the PARENT.
         * Anonymizes teacher/TA names to "Teacher Observation".
         */
        function renderParentActivityLog(logs) {
            elements.parentActivityLog.innerHTML = '';
            
            if (!logs || logs.length === 0) {
                elements.parentActivityLog.innerHTML = '<p class="text-gray-500">No activity logged yet.</p>';
                return;
            }
            
            logs.forEach(log => {
                const isParentLog = log.reporter === 'parent';
                
                // Privacy logic:
                let reporterDisplay = isParentLog ? "Parent Observation" : "Teacher Observation";
                let bgColor = isParentLog ? "bg-blue-50" : "bg-green-50";
                let titleColor = isParentLog ? "text-blue-700" : "text-green-700";
                
                const logEl = document.createElement('div');
                logEl.className = `p-4 rounded-lg border ${bgColor} ${isParentLog ? 'border-blue-200' : 'border-green-200'} shadow-sm`;
                logEl.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold ${titleColor}">${log.goal}</span>
                        <span class="text-sm font-medium text-gray-600">${formatDate(log.date)}</span>
                    </div>
                    <p class="text-gray-700 mb-2">"${log.statement}"</p>
                    <div class="flex justify-between items-baseline">
                        <span class="text-sm font-medium ${titleColor}">${log.classifier}</span>
                        <span class="text-xs text-gray-500">by ${reporterDisplay}</span>
                    </div>
                `;
                elements.parentActivityLog.appendChild(logEl);
            });
        }
        
        // --- Initialization ---

        function main() {
            console.log("DOM content loaded. Initializing app...");
            
            // Call Auth first, as it's responsible for showing the UI
            initializeAppAndAuth();
            
            // Safely attach listeners
            try {
                const today = formatDate(new Date());
                elements.progressDate.value = today;
                elements.parentObsDate.value = today;
                
                // --- Attach all event listeners ---
                elements.teacherRoleBtn?.addEventListener('click', showTeacherLogin);
                elements.parentRoleBtn?.addEventListener('click', showParentLogin);
                
                elements.teacherBackBtn?.addEventListener('click', showRoleSelector);
                elements.parentBackBtn?.addEventListener('click', showRoleSelector);
                
                elements.teacherLoginBtn?.addEventListener('click', handleTeacherLogin);
                
                elements.loadClassBtn?.addEventListener('click', createOrLoadClass);
                elements.addStudentBtn?.addEventListener('click', addStudent);
                elements.addGoalBtn?.addEventListener('click', addGoal);
                elements.logProgressBtn?.addEventListener('click', logProgress);
                
                elements.parentLoginBtn?.addEventListener('click', handleParentLogin);
                elements.logParentObsBtn?.addEventListener('click', logParentObservation);

                console.log("Event listeners attached successfully.");
                
            } catch(error) {
                console.error("Error attaching one or more event listeners:", error);
                // Auth init should still show the UI, but buttons might not work
                showAuthError("Error: App failed to attach controls. Please refresh.");
            }
        }

        // Use DOMContentLoaded to ensure the script runs after the HTML is parsed
        document.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>

